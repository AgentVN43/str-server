name: CI/CD Strapi

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js (18.x)
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      # C√†i dependencies ƒë·ªÉ ƒë·∫£m b·∫£o lockfile h·ª£p l·ªá (kh√¥ng build t·∫°i CI)
      - name: Install deps (npm i -> npm ci)
        run: |
          npm i --no-audit --no-fund || true
          npm ci
          npm install pg --save

      - name: Deploy Strapi to VPS
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        run: |
          echo "üîÅ Sync source code..."
          sshpass -e rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" \
                    --exclude '.git' --exclude '.github' --exclude 'node_modules' \
                    --exclude '.env' --exclude 'types/generated' \
                    ./ $SERVER_USER@$SERVER_HOST:/www/wwwroot/strapi.annk.info/ || true


          echo "‚öôÔ∏è  Build & restart Strapi..."
          sshpass -e ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'EOF'
            cd /www/wwwroot/strapi.annk.info
            echo "[1/3] Build Strapi..."
            NODE_ENV=production npm run build

            echo "[2/3] Restart via PM2..."
            pm2 delete strapi 
            pm2 start "npm run start" --name strapi --cwd /www/wwwroot/strapi.annk.info
            pm2 save

            echo "[3/3] Verify service..."
            curl -sI http://127.0.0.1:1337/admin | head -n1 || true
          EOF
