name: CI/CD Strapi

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Kh√¥ng c·∫ßn build hay PM2 tr√™n CI. Build/PM2 s·∫Ω ch·∫°y ·ªü VPS.
      - name: Deploy to VPS (rsync + build + pm2)
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}   # sshpass d√πng bi·∫øn n√†y
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }} # vd: /www/wwwroot/strapi.annk.info
        run: |
          echo "üîÅ Rsync source..."
          sshpass -e rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" \
            --exclude '.git' --exclude '.github' --exclude 'node_modules' \
            --exclude '.env' --exclude 'types/generated' \
            ./ "$SERVER_USER@$SERVER_HOST:$SERVER_PATH/"

          echo "‚öôÔ∏è Build & restart on server..."
          sshpass -e ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" << 'EOF'
            set -e
            cd "$SERVER_PATH"

            echo "[1/3] Install deps"
            npm i --no-audit --no-fund || true
            node -e "require('pg')" 2>/dev/null || npm install pg --save

            echo "[2/3] Build Strapi"
            NODE_ENV=production npm run build

            echo "[3/3] PM2 (re)start"
            pm2 restart strapi || pm2 start "npm run start" --name strapi --cwd "$SERVER_PATH"
            pm2 save

            echo "Smoke test:"
            curl -sI http://127.0.0.1:1337/admin | head -n1 || true
          EOF
