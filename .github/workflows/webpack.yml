name: CI/CD Strapi

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # (Kh√¥ng c·∫ßn c√†i deps ·ªü CI; build s·∫Ω di·ªÖn ra tr√™n server)
      - name: Deploy Strapi to VPS
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PATH: /www/wwwroot/strapi.annk.info
        run: |
          echo "üîÅ Sync source code..."
          sshpass -e rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" \
            --exclude '.git' --exclude '.github' --exclude 'node_modules' \
            --exclude '.env' --exclude 'types/generated' \
            ./ $SERVER_USER@$SERVER_HOST:$SERVER_PATH/ || true

          echo "‚öôÔ∏è  Build & restart Strapi on server..."
          sshpass -e ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'EOF'
            set -e
            cd /www/wwwroot/strapi.annk.info

            echo "[1/4] Install deps..."
            npm i --no-audit --no-fund || true
            npm ci
            npm install pg --save

            echo "[2/4] Build Strapi..."
            NODE_ENV=production npm run build

            echo "[3/4] (Re)start via PM2..."
            pm2 restart strapi || pm2 start "npm run start" --name strapi --cwd /www/wwwroot/strapi.annk.info
            pm2 save

            echo "[4/4] Smoke test upstream..."
            curl -sI http://127.0.0.1:1337/admin | head -n1 || true
          EOF
